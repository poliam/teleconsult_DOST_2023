{% extends 'base.html' %}

{% block title %} Patient List {% endblock title %}

{% block style %}
<link rel="stylesheet" type="text/css" href="//cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<style type="text/css">
	.dashboard_welcome_greeting{
		color: #6417A1;
	}
	.add_patient_btn{
		border: 1px solid;
		border-color: #6417A180;
		background-color: white;
		color: #6417A180;
		border: 1px solid #6417A180;
		transition: all 0.3s ease;
	}
	.add_patient_btn:hover{
		background-color: #6417A180;
		color: white;
	}
	#patient_list thead{
		background-color: #6417A180;
	}
	.patient_list_name a{
		color: #6417A180;
		font-weight: 700;
	}
	#patient_list{
		padding-top: 1rem;
	}
	#workplace_filter{
		color: #6417A180;
		border: 1px solid #6417A180;
		border-radius: 4px;
		padding: 6px 12px;
		margin-top: 8px;
		transition: all 0.3s ease;
	}
	#workplace_filter:hover{
		color: white;
		border-color: #6417A1;
		background-color: #6417A180;
		box-shadow: 0 2px 4px rgba(100, 23, 161, 0.1);
	}
	#workplace_filter:focus{
		border-color: #6417A1;
		box-shadow: 0 0 0 0.2rem rgba(100, 23, 161, 0.25);
	}
</style>
{% endblock style %}

{% block content %}
{% csrf_token %}
<div class="container-fluid">
	<br/>
	<div class="row">
		<div class="col-sm-12">
			<h2 class="dashboard_welcome_greeting">Patient List</h2>
		</div>
		
	</div>
	<br/>
	<div class="row">
		<div class="col-sm-1"></div>
		<div class="col-sm-10">
			<div class="row mb-2 ">
				<div class="col-sm-2">
					<select class="form-control" id="workplace_filter">
						<option value="">Filter By Location</option>
						<option value="Jeddah">Jeddah</option>
						<option value="Riyadh">Riyadh</option>
					</select>
				</div>
				<div class="col-sm-6"></div>
				<div class="col-sm-4" style="text-align:right;">
					<a href="{% url 'PatientCreate' %}" style="text-decoration:none;">
						<button type="button" class="btn add_patient_btn">Add Patient</button>				
					</a>
				</div>
			</div>
			<table class="table" id="patient_list">
				<thead>
					<th>No.</th>
					<th>Patient Name</th>
					<th>Gender</th>
					<th>Marital Status</th>
					<th>Age</th>
					<th>Workplace</th>
					<th>Actions</th>
				</thead>
				<tbody>
					{% if list_of_patients %}
						{% for patient in list_of_patients %}
							<tr>
								<td>{{ forloop.counter }}</td>
								<td class="patient_list_name"><a href="{% url 'PatientDetailed' patient.pk %}" style="text-decoration:none;">{{ patient.last_name }}, {{ patient.first_name }} {{ patient.middle_name }}</a> </td>
								<td>{{ patient.gender }}</td>
								<td>{{ patient.marital_status }}</td>
								<td>{{ patient.age }}</td>
								<td>{{ patient.workplace }}</td>
								<td>
									{% if group_type == "Admin" %}
										<a href="#" attr_id="{{ patient.pk }}" onclick="deletePatient(this)" style="text-decoration:none;">
											<i class="fa-solid fa-trash-can" style="color:red;"></i>
										</a>
									{% endif %}
								</td>
							</tr>
						{% endfor %}
					{% endif %}
					
				</tbody>
			</table>
		</div>
		<div class="col-sm-1"></div>
	</div>
</div>
{% endblock content %}


{% block script %}
<script type="text/javascript" src="//cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script type="text/javascript">
	$(document).ready(function(){
		let table = new DataTable('#patient_list');
		
		// Add workplace filter functionality
		$('#workplace_filter').on('change', function() {
			let selectedWorkplace = $(this).val();
			if (selectedWorkplace === '') {
				// Show all rows if "All Workplaces" is selected
				table.column(5).search('').draw();
			} else {
				// Filter by selected workplace (column index 5 is the workplace column)
				table.column(5).search(selectedWorkplace).draw();
			}
		});
	})
	
	function deletePatient(that) {
		if (!confirm('Are you sure you want to delete this patient record? The patient will be removed from the list but can be restored by an administrator if needed.')) {
			return;
		}
		var patient_id = $(that).attr("attr_id");
		$.ajax({
			type: "POST",
			url: "{% url 'PatientDelete' %}",
			data: {
				"patient_id": patient_id,
				"csrfmiddlewaretoken": $('[name=csrfmiddlewaretoken]').val()
			},
			async: true,
			success: function (data) {
				if (data.success) {
					alert('Patient record deleted successfully.');
					window.location.reload();
				} else {
					alert('Error deleting patient: ' + data.error);
				}
			},
			error: function (e) {
				alert('An error occurred while deleting the patient.');
			}
		});
	}
	
</script>
{% endblock script %}
